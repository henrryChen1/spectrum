"use strict";var timer=null,rightWidth=0,between_w=0,tableTitleH=50,columnH=30,tableFill="#4a90e2",fieldFill="#f0f7ff",Fun,page={start:function(){Fun=page.func,Fun.initEvent(),rightWidth=$("#container").width()-$("#leftPanel").width()-10,$("#rightPanel").css("width",rightWidth+"px")},searchText:"",resultJson:{},hierarchys:[],hierarchy_tables:[],directSource:[],directTarget:[],directSLinks:[],directTLinks:[],inDirectLinks:[],inDirectSLinks:[],inDirectTLinks:[],inDirectSource:[],inDirectTarget:[],graph:{},paper:{},nodes:[],links:[],rect_nodes:[],zTree_menu:{},treeSetting:"",treeNodes:[],curMenu:{},preMenu:{},linkTable:[],func:{initEvent:function(){$(document).on("keypress","#searchInput",function(e){13===e.keyCode&&Fun.getTreeNodes()}),$(document).on("click","#initDataButton",function(e){Fun.reCalculate()}),$(document).on("click","#uploadExcelButton",function(e){document.querySelector("#uploadFile").click()}),window.onresize=function(){rightWidth=$("#container").width()-$("#leftPanel").width()-10,$("#rightPanel").css("width",rightWidth+"px")},$("#uploadFile").on("change",function(e){Fun.checkFile(e.target.files)&&Fun.uploadFile(e.target.files[0])})},showLoading:function(e){var n=document.createElement("div");n.innerHTML=e,n.style.cssText="width:160px;line-height:60px;text-align:center;color:#fff;background:#000;position: fixed;left: 50%;top: 50%;margin: -40px 0 0 -80px;z-index:100;border-radius: 10px;",document.body.appendChild(n),setTimeout(function(){n.parentNode.removeChild(n)},1500)},checkFile:function(e){if(!e||0===e.length)return Fun.showLoading("请选择上传文件"),!1;var n=e[0].name.substr(e[0].name.lastIndexOf(".")+1);return"xls"===n||"xlsx"===n||(Fun.showLoading("请选择Excel文件！"),!1)},uploadFile:function(e){submitFileForm("uploadForm",baseUrl+uploadUrl,null,!0,function(e){"success"===e.message?Fun.showLoading("上传成功！"):"error"===e.message&&Fun.showLoading("上传失败！"),$("#uploadFile").val("")})},getTreeNodes:function(){page.searchText=$("#searchInput").val(),getData(baseUrl+fuzztQuery,"get",{tableName:page.searchText},!0,function(e){page.curMenu={},page.preMenu={},page.treeNodes=e,Fun.initTree()})},initTree:function(){page.treeSetting={view:{showLine:!1,showIcon:!1,selectedMulti:!1,dblClickExpand:!1,addDiyDom:Fun.addDiyDom},data:{simpleData:{enable:!0,idKey:"id",pIdKey:"parent",rootPId:0}},callback:{beforeClick:Fun.beforeClick,onClick:Fun.clickNode}};var e=$("#treeDemo");$.fn.zTree.init(e,page.treeSetting,page.treeNodes),page.zTree_Menu=$.fn.zTree.getZTreeObj("treeDemo"),e.hover(function(){e.hasClass("showIcon")||e.addClass("showIcon")},function(){e.removeClass("showIcon")})},addDiyDom:function(e,n){var t=$("#"+n.tId+"_switch"),a=$("#"+n.tId+"_ico");if(t.remove(),a.before(t),n.level>0){var r='<span style="display: inline-block; width:'+10*(n.level+1)+'px"></span>';t.before(r)}},beforeClick:function(e,n){if(page.preMenu=page.curMenu,n.children){return $.fn.zTree.getZTreeObj("treeDemo").expandNode(n,!0),page.curMenu=n,page.zTree_Menu.selectNode(page.curMenu),!0}return 0!==n.level&&(page.curMenu=n,page.zTree_Menu.selectNode(page.curMenu),!0)},clickNode:function(e,n){page.curMenu.name===page.preMenu.name&&page.curMenu.name||(page.preMenu.name?0!==page.curMenu.parent?page.curMenu.parent===page.preMenu.parent?Fun.getFieldResultJson(function(){Fun.addNodesToGraph(),Fun.addLinkToGraph(),Fun.fitContent()}):page.curMenu.parent===page.preMenu.id?Fun.getFieldResultJson(function(){Fun.addNodesToGraph(),Fun.addLinkToGraph(),Fun.fitContent()}):page.curMenu.parent===page.preMenu.id&&page.curMenu.parent===page.preMenu.parent||Fun.getFieldResultJson(function(){Fun.addNodesToGraph(),Fun.addLinkToGraph(),Fun.fitContent()}):0===page.curMenu.parent&&(page.curMenu.parent===page.preMenu.parent||page.curMenu.id!==page.preMenu.parent?Fun.getResultJson(function(){Fun.addNodesToGraph(),Fun.addLinkToGraph(),Fun.fitContent()}):page.curMenu.id===page.preMenu.parent&&Fun.getResultJson(function(){Fun.addNodesToGraph(),Fun.addLinkToGraph(),Fun.fitContent()})):($("#basicInfo").css("display","inline-block"),$("#tableRelated").css("display","block"),$("#basicTitle").css("display","block"),0===page.curMenu.parent?Fun.getResultJson(function(){Fun.addNodesToGraph(),Fun.addLinkToGraph(),Fun.fitContent()}):Fun.getFieldResultJson(function(){Fun.addNodesToGraph(),Fun.addLinkToGraph(),Fun.fitContent()})))},fitContent:function(){page.paper.fitToContent({padding:{bottom:50,right:30}})},reCalculate:function(){getData(baseUrl+executeData,"get",{},!0,function(e){Fun.getTreeNodes(),$("#basicInfo").css("display","none"),$("#tableRelated").css("display","none"),$("#basicTitle").css("display","none"),page.graph.getCells&&(page.rect_nodes=[],page.graph.removeCells(page.graph.getCells()))})},getResultJson:function(e){var n="";n=0===page.curMenu.parent?page.curMenu.name:page.curMenu.getParentNode().name,getData(baseUrl+relationQuery,"get",{tableName:n},!0,function(n){page.resultJson=n,Fun.renderInfo(),Fun.handleLinks(),page.rect_nodes=[],Fun.initGraph(),e()})},getFieldResultJson:function(e){var n=page.curMenu.getParentNode().name,t=page.curMenu.name;getData(baseUrl+columnQuery,"get",{tableName:n,columnName:t},!0,function(n){page.resultJson=n,Fun.renderInfo(),Fun.handleLinks(),page.rect_nodes=[],Fun.initGraph(),e()})},renderInfo:function(){$("#tableName").text("表名："+page.resultJson.tableName),$("#storeProcedure").text("所属存储过程："+page.resultJson.storeProcedure),$("#tableComment").text("表含义注释："+page.resultJson.comment),$("#sourceTables").empty();var e="";e+='<div class="table-head">来源表</div>',page.resultJson.sourceTables.length>0&&page.resultJson.sourceTables.forEach(function(n,t){e+='<div class="table-item">'+n+"</div>"}),$(e).appendTo($("#sourceTables")),$("#targetTables").empty();var n="";n+='<div class="table-head">影响表</div>',page.resultJson.afterTables.length>0&&page.resultJson.afterTables.forEach(function(e,t){n+='<div class="table-item">'+e+"</div>"}),$(n).appendTo($("#targetTables"));var t=$(window).height()-$("#basicInfo").height()-$("#tableRelated").height()-$("#basicTitle").height()-50;$("#chartContainer").css("min-height",t+"px")},handleLinks:function(){page.linkTable=[];var e,n,t,a,r=page.resultJson.mapJson.Links,i=[];r.forEach(function(r,o){e=0===r.value?r.source:r.target,n=0===r.value?r.target:r.source,0===i.length?(page.linkTable.push([e]),page.linkTable.push([n]),i.push(e),i.push(n)):i.indexOf(e)>-1&&i.indexOf(n)>-1||(-1===i.indexOf(e)&&i.indexOf(n)>-1?(a=Fun.findLinkTableIndex(n),0===a?page.linkTable.unshift([e]):page.linkTable[a-1].push(e),i.push(e)):-1===i.indexOf(n)&&i.indexOf(e)>-1?(t=Fun.findLinkTableIndex(e),t===page.linkTable.length-1?page.linkTable.push([n]):page.linkTable[t+1].push(n),i.push(n)):-1===i.indexOf(n)&&i.indexOf(e))})},findLinkTableIndex:function(e){for(var n=0;n<page.linkTable.length;n++)if(page.linkTable[n].indexOf(e)>-1)return n;return-1},initGraph:function(){page.graph=new joint.dia.Graph,page.paper=new joint.dia.Paper({el:$("#myholder"),w:rightWidth-50,model:page.graph,gridSize:10,interactive:!1}),page.paper.options.defaultAnchor={name:"left",args:{dx:0,dy:0,padding:10}},page.paper.$el.on("click",function(e){e.stopPropagation(),e.preventDefault();var n=page.paper.findView(e.target);if(n.model.getParentCell()){var t=($("#"+n.id+" tspan"),n.model.attributes.attrs.text.textWrap.text),a=n.model.attributes.attrs.comment,r=(n.model.getParentCell().attributes.position.x,n.model.getParentCell().attributes.position.y,n.model.attributes.position.x),i=n.model.attributes.position.y;a&&(clearTimeout(timer),$("#fieldComment").text(t+": "+a),$("#fieldComment").css("display","inline-block"),$("#fieldComment").css("top",i),$("#fieldComment").css("left",r+20),timer=setTimeout(function(){$("#fieldComment").css("display","none")},1e3))}else $("#fieldComment").css("display","none")})},getHierarchyAndRelatedTables:function(){var e;page.resultJson.mapJson.Datas.forEach(function(n,t){e=page.hierarchys.indexOf(n.hierarchy),n.index=t,-1===e?(page.hierarchys.push(n.hierarchy),page.hierarchy_tables.push([]),page.hierarchy_tables[page.hierarchy_tables.length-1].push(n)):page.hierarchy_tables[e].push(n)})},findTableIndex:function(){for(var e=page.resultJson.tableName,n=page.resultJson.mapJson.Datas,t=0;t<n.length;t++)if(n[t].name===e)return t;return-1},findColIndex:function(e,n){for(var t=page.nodes[e],a=t.colums,r=0;r<a.length;r++)if(a[r].name===n)return r;return-1},addNodesToGraph:function(){page.nodes=page.resultJson.mapJson.Datas;for(var e,n,t=50,a=page.linkTable.length,r=[],i=0;i<a;i++)r.push({});var o;page.nodes.forEach(function(a,i){t=50*a.colums.length,n=Fun.setTableElementSettings(a.name,i,t,r),r=n.tmpNodes,o=Fun.findLinkTableIndex(i),e=Fun.createTableElment(n),page.graph.addCell(e),Fun.embedElement(a.colums,e,i),r[o].h=e.attributes.size.height,e.position(n.x,n.y),Fun.embedElmentResetPosition(e,i),page.rect_nodes.push(e)})},setTableElementSettings:function(e,n,t,a){var r,i,o=(page.linkTable.length,Fun.findLinkTableIndex(n));return between_w=300,r=(250+between_w)*o,i=a[o].y?a[o].y+a[o].h+24:30,a[o]={h:t,y:i},{name:e,x:r,y:i,w:250,h:t,tmpNodes:a}},createTableElment:function(e){var n=page.resultJson.tableName===e.name?"#ff5e5f":tableFill,t={position:{x:e.x,y:e.y},size:{width:e.w,height:e.h},attrs:{rect:{fill:n,stroke:"#cccccc","stroke-width":"1px"},text:{refX:"50%",fontSize:14,fill:"#ffffff"}},ports:{groups:{a:{position:{name:"layoutType",args:{dy:5}}},b:{position:{name:"right",args:{dy:2}}}},items:[]}};return t.attrs.text.refY="15px",t.attrs.text.text=e.name,new joint.shapes.standard.Rectangle(t)},embedElement:function(e,n,t){var a,r,i={},o=0,s=0;return e.forEach(function(e,l){o=20*Fun.getColumnH(e,t),i=new joint.shapes.standard.Rectangle({size:{width:250,height:o>columnH?o:columnH},attrs:{rect:{fill:fieldFill,stroke:"#cccccc","stroke-width":"1px"},comment:e.comment,text:{textWrap:{text:e.name,width:-10,height:"50px"},textVerticalAnchor:"middle",refX:"50%",refY:"50%",fontSize:14,fill:"#202020"}},ports:{groups:{a:{position:{name:"layoutType",args:{dy:5}}},b:{position:{name:"right",args:{dy:2}}}},items:[]}}),page.graph.addCell(i),a=n.getEmbeddedCells(),r=a.length,r>0&&(s=a[r-1].attributes.position.y+a[r-1].attributes.size.height-n.attributes.position.y),n.embed(i),i.position(10,s?s+1:columnH,{parentRelative:!0})}),n.fitEmbeds({padding:{top:20}}),n},getColumnH:function(e,n){var t=[],a=[];return t=page.resultJson.mapJson.Links.filter(function(t){return t.target===n&&0===t.value&&t.targetColumn===e.name||t.source===n&&1===t.value&&t.sourceColumn===e.name}),a=page.resultJson.mapJson.Links.filter(function(t){return t.source===n&&0===t.value&&t.sourceColumn===e.name||t.target===n&&1===t.value&&t.targetColumn===e.name}),t.length>a.length?t.length:a.length},embedElmentResetPosition:function(e,n){var t=e.getEmbeddedCells(),a=0;t.forEach(function(n,r){r>0&&(a=t[r-1].attributes.position.y+t[r-1].attributes.size.height-e.attributes.position.y),n.position(0,a?a+1:columnH,{parentRelative:!0})})},addLinkToGraph:function(){page.links=page.resultJson.mapJson.Links;var e,n,t,a;page.links.forEach(function(r,i){0===r.value?(t=Fun.findColIndex(r.source,r.sourceColumn),a=Fun.findColIndex(r.target,r.targetColumn),e=page.rect_nodes[r.source].getEmbeddedCells()[t],n=page.rect_nodes[r.target].getEmbeddedCells()[a]):(t=Fun.findColIndex(r.target,r.targetColumn),a=Fun.findColIndex(r.source,r.sourceColumn),e=page.rect_nodes[r.target].getEmbeddedCells()[t],n=page.rect_nodes[r.source].getEmbeddedCells()[a]),Fun.connection(e,n,a)})},connection:function(e,n,t){var a,r={group:"a",args:{},label:{},attrs:{},markup:'<rect width="2" height="2" x="0" strokegit ="red" fill="gray"/>'};n.addPort(r);var i={group:"b",args:{},label:{},attrs:{},markup:'<rect width="2" height="2" x="0" strokegit ="red" fill="gray"/>'};e.addPort(i),a=new joint.dia.Link({source:{id:e.id,port:e.getPorts()[e.getPorts().length-1].id},target:{id:n.id,port:n.getPorts()[n.getPorts().length-1].id},router:{},attrs:{".connection":{stroke:"#979797"},".marker-target":{d:"M 10 0 L 0 5 L 10 10 z",fill:"grey",stroke:"grey"}}}),a.router(function(e,n,t){return e}),a.addTo(page.graph)}}};page.start();